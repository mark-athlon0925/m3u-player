<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TV</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.png">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <style>
        body { background-color: #121212; }
        .text-remove{overflow:hidden; white-space:nowrap; text-overflow: ellipsis;}
        .channel-card {
            transition: transform 0.2s;
        }
        .channel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.5) !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <v-app dark>
            <v-main>
                <v-container>
                    <v-row v-if="!loading && m3uUrl && m3us.length > 0">
                        <!-- Adjusted: 2 columns on mobile (cols=6) to show more items, 3 on tablet, 4 on desktop -->
                        <v-col cols="6" sm="4" md="3" v-for="m3u in m3us" :key="m3u.title" class="pa-1">
                            <v-card class="mx-auto channel-card fill-height d-flex flex-column" outlined tile color="#1E1E1E" style="border: 1px solid #444 !important;">
                                <a :href="m3u | convertLink" style="text-decoration: none; color: inherit;" class="d-flex flex-column flex-grow-1">
                                    
                                    <!-- Header: Logo & Name -->
                                    <div class="d-flex flex-column align-center pa-2 text-center">
                                        <v-sheet width="60" height="40" color="transparent" class="mb-1 white rounded">
                                            <v-img 
                                                height="100%" 
                                                contain 
                                                :src="m3u.attributes['tvg-logo']"
                                                @error="handleLogoError(m3u)"
                                            >
                                                <template v-slot:placeholder>
                                                    <v-row class="fill-height ma-0" align="center" justify="center">
                                                        <v-icon color="grey darken-2">mdi-television</v-icon>
                                                    </v-row>
                                                </template>
                                                <template v-slot:error>
                                                    <v-row class="fill-height ma-0" align="center" justify="center">
                                                        <v-icon color="grey darken-2">mdi-television-off</v-icon>
                                                    </v-row>
                                                </template>
                                            </v-img>
                                        </v-sheet>
                                        <!-- Channel Name -->
                                        <div class="text-subtitle-1 font-weight-bold text-truncate white--text" style="width: 100%;">
                                            {{ m3u.attributes['tvg-name'] }}
                                        </div>
                                    </div>

                                    <v-divider class="grey darken-2"></v-divider>

                                    <!-- Content: Program Info -->
                                    <div class="px-2 py-2 flex-grow-1 d-flex flex-column justify-start" style="min-height: 70px;">
                                        <template v-if="getEpgInfo(m3u.attributes['tvg-id'] || m3u.attributes['tvg-name'])">
                                            <!-- Program Title -->
                                            <div class="text-body-2 font-weight-bold mb-1 white--text" style="line-height: 1.2; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                                 {{ getEpgInfo(m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']).title }}
                                            </div>
                                            
                                            <v-spacer></v-spacer>

                                            <!-- Time & Progress -->
                                            <div class="d-flex align-center justify-space-between caption grey--text text--lighten-1 mb-1">
                                                <span>{{ getEpgInfo(m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']).startStr }}</span>
                                                <span>{{ getEpgInfo(m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']).endStr }}</span>
                                            </div>
                                            <v-progress-linear
                                                :value="getEpgInfo(m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']).progress"
                                                height="4"
                                                color="blue accent-2"
                                                rounded
                                                background-color="grey darken-3"
                                            ></v-progress-linear>
                                        </template>
                                        <template v-else>
                                            <div class="caption grey--text text--darken-1 text-center py-2 my-auto">
                                                정보 없음
                                            </div>
                                        </template>
                                    </div>
                                </a>
                            </v-card>
                        </v-col>
                    </v-row>
                    <v-row>
                        <v-btn
                            @click="show = !show"
                            block
                            :loading="loading"
                            :disable="loading"
                        >설정</v-btn>
                        </v-row>
                    <v-dialog width="500" v-model="show">
                        <v-card>
                            <v-card-title>설정</v-card-title>
                            <v-card-text>
                                <v-form @submit.prevent="load(m3uUrl)">
                                    <v-text-field v-model="m3uUrl" label="m3u url" :loading="m3uLoading" :disable="m3uLoading" @input="save('m3uUrl', m3uUrl)"></v-text-field>
                                    <div>
                                        <v-btn @click="load(m3uUrl)" :loading="m3uLoading" :disable="m3uLoading">load</v-btn>
                                        <v-btn @click="clear" :loading="m3uLoading" :disable="m3uLoading">clear</v-btn>
                                        <v-switch label="m3uAutoLoad" color="primary" v-model="epgAutoLoad"></v-switch>
                                    </div>
                                </v-form>
                            </v-card-text>
                            <v-card-text>
                                <v-form @submit.prevent="load(epgUrl)">
                                    now: {{ nowFormat }}
                                    <v-text-field v-model="epgUrl" label="epgUrl" :loading="epgLoading" :disable="epgLoading" @input="save('epgUrl', epgUrl)"></v-text-field>
                                    <v-text-field type="number" v-model="epgHour" label="addHour" :loading="epgLoading" @input="save('epgHour', epgHour)" :disable="epgLoading"></v-text-field>
                                    <v-btn @click="loadEpg(epgUrl)" :loading="epgLoading" :disable="m3uLoading">load</v-btn>
                                    <v-btn @click="clearEpg" :loading="epgLoading" :disable="epgLoading">clear</v-btn>
                                </v-form>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue darken-1" text @click="show = false">닫기</v-btn>
                                <v-btn @click="loadAll" :loading="loading" :disable="loading">전체 새로고침</v-btn>
                            </v-card-actions>
                            <div style="height: 300px"></div>
                        </v-card>
                    </v-dialog>
                </v-container>
            </v-main>
        </v-app>
    </div>
    <script src="/js/util.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/m3u-parser-generator@1/dist/browser-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify({
                theme: { dark: true }
            }),
            data() {
                return {
                    key: 0,
                    m3us: [],
                    m3uUrl: null,
                    epgUrl: null,
                    epgs: [],
                    epgData: {}, // Optimized Map
                    m3uLoading: false,
                    epgLoading: false,
                    epgAutoLoad: true,
                    show: false,
                    epgHour: 0,
                    now: null
                }
            },
            filters: {
                convertLink(v) {
                    return `player.html?id=${encodeURIComponent(v.location)}&title=${encodeURIComponent(v.name)}`
                }
            },
            computed: {
                loading() {
                    return this.m3uLoading || this.epgLoading
                },
                nowFormat(){
                    return this.now?.add(this.epgHour, 'hour').format('YYYY-MM-DD HH:mm:ss')
                }
            },
            watch:{
                epgAutoLoad(epgAutoLoad){
                    console.log(epgAutoLoad)
                    localStorage.epgAutoLoad = epgAutoLoad
                }
            },
            async created() {
                this.now = dayjs()
                // Update 'now' every minute to trigger reactivity for progress bars
                setInterval(() => {
                    this.now = dayjs();
                }, 60 * 1000);

                const { epgAutoLoad, m3us , epgUrl, m3uUrl, apiKey, epgHour} = localStorage
                this.epgUrl = epgUrl
                this.m3uUrl = m3uUrl || apiKey
                this.epgHour = epgHour || 0
                this.epgAutoLoad =  epgAutoLoad ? JSON.parse(epgAutoLoad) : true
                if(this.epgAutoLoad){
                    this.load(this.m3uUrl)
                }else{
                    this.m3us = JSON.parse(m3us) || []
                }
                
                await this.loadEpg(this.epgUrl)
            },
            methods: {
                handleLogoError(item) {
                    // Prevent infinite loop
                    if (item.logoRetried) return;
                    
                    item.logoRetried = true;
                    const name = item.attributes['tvg-name'] || item.attributes['tvg-id'];
                    if (!name) return;

                    // Sanitize name for tv-logo repository format
                    // Rule: Lowercase, spaces to dashes, remove special chars
                    const sanitized = name.toLowerCase()
                        .replace(/\s+/g, '-')     // Spaces to dashes
                        .replace(/\(.*\)/g, '')   // Remove parenthesis content like (FHD)
                        .replace(/[^a-z0-9\-]/g, ''); // Remove other special chars
                    
                    // Try Fallback Source (tv-logo/tv-logos repository)
                    // You can add more repositories here
                    const fallbackUrl = `https://raw.githubusercontent.com/tv-logo/tv-logos/main/countries/kr/${sanitized}.png`;
                    
                    // Update logo (Vue reactivity)
                    this.$set(item.attributes, 'tvg-logo', fallbackUrl);
                },
                getEpgInfo(channel) {
                    if (!channel) return null;
                    if (!this.epgData || !this.epgData[channel]) return null;
                    
                    // Use reactive 'this.now' converted to Date for comparison
                    const now = this.now ? this.now.toDate() : new Date();
                    if (this.epgHour) {
                        // Adjust 'now' based on epgHour offset only if needed for logic
                        // But typically epgHour is applied to EPG data during parsing.
                        // Let's check logic: parseEPG applies offset to start/stop. 
                        // So we should compare with real current time.
                        // BUT, if user set offset because their system time is different from EPG time...
                        // Actually parseEPG applies offset to the PROGRAM times. 
                        // So 'now' should be just real now.
                    }
                    
                    const programs = this.epgData[channel];
                    const prog = programs.find(p => now >= p.start && now < p.stop);

                    if (!prog) return null;
                    
                    // Calculate progress using timestamps
                    const totalMs = prog.stop - prog.start;
                    const elapsedMs = now - prog.start;
                    const progress = Math.min(100, Math.max(0, (elapsedMs / totalMs) * 100));
                    
                    // Helper for formatting time (HH:mm)
                    const formatTime = (date) => {
                        return dayjs(date).format('HH:mm');
                    };

                    return {
                        title: prog.title,
                        startStr: formatTime(prog.start),
                        endStr: formatTime(prog.stop),
                        progress: progress
                    };
                },
                findEpg(channel) {
                    const now = dayjs().add(this.epgHour, 'hour')
                    const format = 'YYYY-MM-DD HH:mm:ss'
                    const length = 14
                    const r = this.epgs.filter(r => r.$.channel === channel).find(r => {
                        const { start, stop } = r.$
                        const dStart = dayjs(start.substring(0, length))
                        const dStop = dayjs(stop.substring(0, length))
                        if(dStart <= now && now <= dStop){
                            return true
                        }
                    })
                    return r
                },
                save(key, value){
                    localStorage[key] = value
                },
                async load(m3uUrl){
                    if(!m3uUrl || this.m3uLoading){
                        return
                    }
                    try{
                        this.m3uLoading = true
                        const data = await fetch(`${m3uUrl}`)
                        if(data.status === 403){
                            alert('사용 불가.')
                            this.clear()
                            return
                        }
                        localStorage.m3uUrl = m3uUrl
                        const m3u = await data.text()
                        const { medias }  = m3uParserGenerator.M3uParser.parse(m3u);
                        this.m3us = medias
                        localStorage.m3us = JSON.stringify(this.m3us)
                    }finally{
                        this.m3uLoading = false
                    }
                },
                clear(){
                    this.m3uUrl = null
                    this.m3us = null
                    delete localStorage.m3uUrl
                    delete localStorage.m3us
                },
                async loadEpg(epgUrl){
                    if(!epgUrl || this.epgLoading){
                        return
                    }
                    try{
                        this.epgLoading = true
                        const data = await fetch(`${epgUrl}`)
                        localStorage.epgUrl = epgUrl
                        const xml = await data.text()
                        
                        this.parseEPG(xml);
                    } catch(e) {
                        console.error(e);
                        alert('epg load fail');
                    } finally {
                        this.epgLoading = false
                    }
                },
                parseEPG(xmlContent) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    const programmes = xmlDoc.getElementsByTagName("programme");
                    
                    const newEpgData = {};

                    // Helper to parse XMLTV date: YYYYMMDDHHMMSS +0000
                    const parseDate = (dateStr) => {
                        if (!dateStr) return null;
                        const y = dateStr.substring(0, 4);
                        const m = parseInt(dateStr.substring(4, 6)) - 1; 
                        const d = dateStr.substring(6, 8);
                        const h = dateStr.substring(8, 10);
                        const min = dateStr.substring(10, 12);
                        const s = dateStr.substring(12, 14);
                        
                        let date = new Date(y, m, d, h, min, s);
                        
                        // Apply Manual Offset (using epgHour)
                        if (this.epgHour) {
                            date.setHours(date.getHours() + parseInt(this.epgHour));
                        }
                        return date;
                    };

                    for (let i = 0; i < programmes.length; i++) {
                        const prog = programmes[i];
                        const channelId = prog.getAttribute("channel");
                        const start = parseDate(prog.getAttribute("start"));
                        const stop = parseDate(prog.getAttribute("stop"));
                        
                        let title = "No Title";
                        const titleNode = prog.getElementsByTagName("title")[0];
                        if (titleNode) title = titleNode.textContent;

                        if (!newEpgData[channelId]) {
                            newEpgData[channelId] = [];
                        }
                        
                        newEpgData[channelId].push({
                            start,
                            stop,
                            title
                        });
                    }
                    this.epgData = newEpgData;
                }, 
                clearEpg(){
                    this.epgUrl = null
                    delete localStorage.epgUrl
                },
                async loadAll(){
                    await Promise.all([
                        this.loadEpg(this.epgUrl),
                        this.load(this.m3uUrl)
                    ])
                },
            },
        })
    </script>
</body>
</html>
