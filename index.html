<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TV</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.png">
    <link href="/lib/fonts/roboto/roboto.css" rel="stylesheet">
    <link href="/lib/fonts/mdi/materialdesignicons.min.css" rel="stylesheet">
    <link href="/lib/css/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <style>
        body { background-color: #121212; }
        .text-remove{overflow:hidden; white-space:nowrap; text-overflow: ellipsis;}
        .channel-card {
            transition: transform 0.2s;
        }
        .channel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.5) !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <v-app dark>
            <v-app-bar app dark dense flat color="#1E1E1E" style="border-bottom: 1px solid #333 !important;">
                <v-icon class="mr-2">mdi-television-play</v-icon>
                <v-toolbar-title class="text-subtitle-1 font-weight-bold"></v-toolbar-title>
                <v-spacer></v-spacer>
                <v-text-field
                    v-if="m3us && m3us.length > 0"
                    v-model="search"
                    prepend-inner-icon="mdi-magnify"
                    placeholder="채널 검색"
                    single-line
                    hide-details
                    clearable
                    dense
                    outlined
                    dark
                    class="mx-2"
                    style="max-width: 300px;"
                ></v-text-field>
                <v-spacer></v-spacer>
                <v-btn icon @click="show = !show" :loading="loading">
                    <v-icon>mdi-cog</v-icon>
                </v-btn>
            </v-app-bar>
            <v-main>
                <v-container class="pt-4">
                    <v-row v-if="!loading && m3uUrl && filteredM3us.length > 0">
                        <v-col cols="6" sm="4" md="3" v-for="m3u in filteredM3us" :key="m3u.title" class="pa-1">
                            <v-card class="mx-auto channel-card fill-height d-flex flex-column" outlined tile color="#1E1E1E" style="border: 1px solid #444 !important;">
                                <a :href="m3u | convertLink" style="text-decoration: none; color: inherit;" class="d-flex flex-column flex-grow-1">
                                    
                                    <!-- Header: Logo & Name -->
                                    <div class="d-flex flex-column align-center pa-2 text-center">
                                        <v-sheet width="60" height="40" color="transparent" class="mb-1 white rounded">
                                            <v-img 
                                                height="100%" 
                                                contain 
                                                :src="m3u.attributes['tvg-logo']"
                                                @error="handleLogoError(m3u)"
                                            >
                                                <template v-slot:placeholder>
                                                    <v-row class="fill-height ma-0" align="center" justify="center">
                                                        <v-icon color="grey darken-2">mdi-television</v-icon>
                                                    </v-row>
                                                </template>
                                                <template v-slot:error>
                                                    <v-row class="fill-height ma-0" align="center" justify="center">
                                                        <v-icon color="grey darken-2">mdi-television-off</v-icon>
                                                    </v-row>
                                                </template>
                                            </v-img>
                                        </v-sheet>
                                        <!-- Channel Name -->
                                        <div class="text-subtitle-1 font-weight-bold text-truncate white--text" style="width: 100%;">
                                            {{ m3u.attributes['tvg-name'] }}
                                        </div>
                                    </div>

                                    <v-divider class="grey darken-2"></v-divider>

                                    <!-- Content: Program Info -->
                                    <div class="px-2 py-2 flex-grow-1 d-flex flex-column justify-start" style="min-height: 70px;">
                                        <template v-if="epgInfoMap[m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']]">
                                            <!-- Program Title -->
                                            <div class="text-body-2 font-weight-bold mb-1 white--text" style="line-height: 1.2; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                                 {{ epgInfoMap[m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']].title }}
                                            </div>

                                            <v-spacer></v-spacer>

                                            <!-- Time & Progress -->
                                            <div class="d-flex align-center justify-space-between caption grey--text text--lighten-1 mb-1">
                                                <span>{{ epgInfoMap[m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']].startStr }}</span>
                                                <span>{{ epgInfoMap[m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']].endStr }}</span>
                                            </div>
                                            <v-progress-linear
                                                :value="epgInfoMap[m3u.attributes['tvg-id'] || m3u.attributes['tvg-name']].progress"
                                                height="4"
                                                color="blue accent-2"
                                                rounded
                                                background-color="grey darken-3"
                                            ></v-progress-linear>
                                        </template>
                                        <template v-else>
                                            <div class="caption grey--text text--darken-1 text-center py-2 my-auto">
                                                정보 없음
                                            </div>
                                        </template>
                                    </div>
                                </a>
                            </v-card>
                        </v-col>
                    </v-row>
                    <!-- 빈 상태 안내 -->
                    <v-row v-if="!loading && (!m3uUrl || !m3us || m3us.length === 0)" justify="center" class="my-8">
                        <v-col cols="12" class="text-center">
                            <v-icon size="64" color="grey darken-1">mdi-television-guide</v-icon>
                            <div class="text-h6 grey--text mt-4">채널이 없습니다</div>
                            <div class="caption grey--text text--darken-1 mt-1">아래 설정 버튼에서 M3U URL을 등록해주세요</div>
                        </v-col>
                    </v-row>
                    <!-- 검색 결과 없음 -->
                    <v-row v-else-if="!loading && m3us.length > 0 && filteredM3us.length === 0" justify="center" class="my-8">
                        <v-col cols="12" class="text-center">
                            <v-icon size="48" color="grey darken-1">mdi-magnify-close</v-icon>
                            <div class="text-subtitle-1 grey--text mt-2">검색 결과가 없습니다</div>
                        </v-col>
                    </v-row>
                    <v-dialog max-width="500" v-model="show">
                        <v-card>
                            <v-card-title>설정</v-card-title>
                            <v-card-text>
                                <v-form @submit.prevent="load(m3uUrl)">
                                    <v-text-field v-model="m3uUrl" label="M3U URL" :loading="m3uLoading" :disabled="m3uLoading" @input="save('m3uUrl', m3uUrl)"></v-text-field>
                                    <div>
                                        <v-btn @click="load(m3uUrl)" :loading="m3uLoading" :disabled="m3uLoading">불러오기</v-btn>
                                        <v-btn @click="clear" :loading="m3uLoading" :disabled="m3uLoading">초기화</v-btn>
                                        <v-switch label="자동 로드" color="primary" v-model="epgAutoLoad"></v-switch>
                                    </div>
                                </v-form>
                            </v-card-text>
                            <v-card-text>
                                현재 시각: {{ nowFormat }}
                                <div class="d-flex align-center mb-2">
                                    <v-text-field v-model="newEpgUrl" label="EPG URL 추가" dense hide-details class="mr-2" :disabled="epgLoading" @keydown.enter="addEpg"></v-text-field>
                                    <v-btn small @click="addEpg" :disabled="epgLoading">추가</v-btn>
                                </div>
                                <v-radio-group v-model="selectedEpgIdx" dense hide-details class="mt-0" v-if="epgList.length > 0">
                                    <div v-for="(epg, idx) in epgList" :key="idx" class="d-flex align-center">
                                        <v-radio :value="idx" class="mr-1 flex-grow-0"></v-radio>
                                        <span class="text-caption text-truncate flex-grow-1" style="max-width: 350px;">{{ epg.url }}</span>
                                        <v-btn icon x-small @click="removeEpg(idx)"><v-icon small>mdi-close</v-icon></v-btn>
                                    </div>
                                </v-radio-group>
                                <v-text-field type="number" v-model="epgHour" label="EPG 시간 보정 (시)" :loading="epgLoading" @input="save('epgHour', epgHour)" :disabled="epgLoading"></v-text-field>
                                <v-btn @click="loadEpg(selectedEpgUrl, true)" :loading="epgLoading" :disabled="epgLoading">불러오기</v-btn>
                                <v-btn @click="clearEpg" :loading="epgLoading" :disabled="epgLoading">초기화</v-btn>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue darken-1" text @click="show = false">닫기</v-btn>
                                <v-btn @click="loadAll" :loading="loading" :disabled="loading">전체 새로고침</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </v-container>
            </v-main>
            <v-snackbar v-model="snackbar" :color="snackbarColor" :timeout="3000" bottom>
                {{ snackbarText }}
                <template v-slot:action="{ attrs }">
                    <v-btn text v-bind="attrs" @click="snackbar = false">닫기</v-btn>
                </template>
            </v-snackbar>
        </v-app>
    </div>
    <script src="/js/util.js"></script>
    <script src="/js/tv-common.js"></script>
    <script src="/lib/js/vue.min.js"></script>
    <script src="/lib/js/vuetify.min.js"></script>
    <script src="/lib/js/m3u-parser-generator.min.js"></script>
    <script src="/lib/js/dayjs.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            mixins: [TvMixin],
            vuetify: new Vuetify({
                theme: { dark: true }
            }),
            data() {
                return {
                    key: 0,
                    search: '',
                    m3us: [],
                    m3uUrl: null,
                    epgList: [],
                    selectedEpgIdx: 0,
                    newEpgUrl: '',
                    epgs: [],
                    epgData: {},
                    m3uLoading: false,
                    epgLoading: false,
                    epgAutoLoad: true,
                    show: false,
                    epgHour: 0,
                    now: null,
                    snackbar: false,
                    snackbarText: '',
                    snackbarColor: 'error'
                }
            },
            filters: {
                convertLink(v) {
                    return `player.html?id=${encodeURIComponent(v.location)}&title=${encodeURIComponent(v.name)}`
                }
            },
            computed: {
                loading() {
                    return this.m3uLoading || this.epgLoading
                },
                nowFormat(){
                    return this.now?.add(this.epgHour, 'hour').format('YYYY-MM-DD HH:mm:ss')
                },
                selectedEpgUrl() {
                    const epg = this.epgList[this.selectedEpgIdx];
                    return epg ? epg.url : null;
                },
                filteredM3us() {
                    const list = this.m3us || [];
                    if (!this.search) return list;
                    const q = this.search.toLowerCase();
                    return list.filter(m => {
                        const name = (m.attributes['tvg-name'] || '').toLowerCase();
                        return name.includes(q);
                    });
                }
            },
            watch:{
                epgAutoLoad(epgAutoLoad){
                    console.log(epgAutoLoad)
                    localStorage.epgAutoLoad = epgAutoLoad
                },
                epgList: {
                    deep: true,
                    handler(v) { localStorage.epgList = JSON.stringify(v); }
                },
                selectedEpgIdx(v) {
                    localStorage.selectedEpgIdx = v;
                }
            },
            async created() {
                this.now = dayjs()
                // Update 'now' every minute to trigger reactivity for progress bars
                setInterval(() => {
                    this.now = dayjs();
                }, 60 * 1000);

                try {
                    const { epgAutoLoad, m3us , epgUrl, epgList, selectedEpgIdx, m3uUrl, apiKey, epgHour} = localStorage
                    this.m3uUrl = m3uUrl || apiKey
                    this.epgHour = epgHour || 0
                    this.epgAutoLoad =  epgAutoLoad ? JSON.parse(epgAutoLoad) : true

                    // Load epgList (migrate old epgUrl if exists)
                    if (epgList) {
                        this.epgList = JSON.parse(epgList);
                    } else if (epgUrl) {
                        this.epgList = [{ url: epgUrl }];
                        delete localStorage.epgUrl;
                    }
                    this.selectedEpgIdx = parseInt(selectedEpgIdx) || 0;

                    if(this.epgAutoLoad){
                        this.load(this.m3uUrl)
                    }else{
                        this.m3us = JSON.parse(m3us) || []
                    }
                } catch(e) {
                    console.warn('localStorage 읽기 실패:', e)
                }

                await this.loadEpg(this.selectedEpgUrl)
            },
            methods: {
                showSnackbar(text, color) {
                    this.snackbarText = text
                    this.snackbarColor = color || 'error'
                    this.snackbar = true
                },
                save(key, value){
                    try {
                        localStorage[key] = value
                    } catch(e) {
                        console.warn('localStorage 쓰기 실패:', e)
                    }
                },
                async load(m3uUrl){
                    if(!m3uUrl || this.m3uLoading){
                        return
                    }
                    try{
                        this.m3uLoading = true
                        const data = await fetch(`${m3uUrl}`)
                        if(data.status === 403){
                            this.showSnackbar('사용 불가.')
                            this.clear()
                            return
                        }
                        if(!data.ok){
                            this.showSnackbar('M3U 로드 실패: ' + data.status)
                            return
                        }
                        localStorage.m3uUrl = m3uUrl
                        const m3u = await data.text()
                        const { medias }  = m3uParserGenerator.M3uParser.parse(m3u);
                        this.m3us = medias
                        localStorage.m3us = JSON.stringify(this.m3us)
                    } catch(e) {
                        console.error(e)
                        this.showSnackbar('M3U 로드 실패')
                    } finally{
                        this.m3uLoading = false
                    }
                },
                clear(){
                    this.m3uUrl = null
                    this.m3us = []
                    delete localStorage.m3uUrl
                    delete localStorage.m3us
                },
                async loadEpg(epgUrl, forceRefresh){
                    if(!epgUrl || this.epgLoading){
                        return
                    }
                    try{
                        this.epgLoading = true

                        if (!forceRefresh) {
                            const cached = EpgCache.get(epgUrl);
                            if (cached) {
                                this.parseEPG(cached);
                                return;
                            }
                        }

                        const data = await fetch(`${epgUrl}`)
                        localStorage.epgUrl = epgUrl
                        const xml = await data.text()
                        EpgCache.set(epgUrl, xml);
                        this.parseEPG(xml);
                    } catch(e) {
                        console.error(e);
                        this.showSnackbar('EPG 로드 실패');
                    } finally {
                        this.epgLoading = false
                    }
                },
                addEpg() {
                    if (!this.newEpgUrl) return;
                    this.epgList.push({ url: this.newEpgUrl });
                    this.newEpgUrl = '';
                },
                removeEpg(idx) {
                    this.epgList.splice(idx, 1);
                    if (this.selectedEpgIdx >= this.epgList.length) {
                        this.selectedEpgIdx = Math.max(0, this.epgList.length - 1);
                    }
                },
                clearEpg(){
                    this.epgList = [];
                    this.selectedEpgIdx = 0;
                    this.epgData = {};
                    delete localStorage.epgList;
                    delete localStorage.selectedEpgIdx;
                    EpgCache.clear();
                },
                async loadAll(){
                    await Promise.all([
                        this.loadEpg(this.selectedEpgUrl),
                        this.load(this.m3uUrl)
                    ])
                },
            },
        })
    </script>
</body>
</html>
